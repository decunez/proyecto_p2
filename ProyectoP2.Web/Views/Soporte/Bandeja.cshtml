@{
    ViewData["Title"] = "Bandeja de Soporte";
}

<style>
    /* === NUEVO: OCULTAR MENÚ Y BURBUJA DEL LAYOUT === */
    /* Esto oculta la barra de navegación superior y el botón flotante solo aquí */
    header, nav, .navbar {
        display: none !important;
    }

    #btnFlotante, #widgetSoporte {
        display: none !important;
    }

    /* Ajuste para que el contenido suba y ocupe toda la pantalla */
    body {
        padding-top: 0 !important;
    }

    main {
        margin-top: 0 !important;
    }

    /* === ESTILOS DEL CHAT === */
    .mensaje {
        max-width: 75%;
        padding: 10px 15px;
        border-radius: 18px;
        position: relative;
        font-size: 0.95rem;
        line-height: 1.4;
        box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        word-wrap: break-word;
    }

    .msg-cliente {
        align-self: flex-start;
        background-color: #ffffff;
        border: 1px solid #e0e0e0;
        color: #333;
        border-bottom-left-radius: 4px;
    }

    .msg-admin {
        align-self: flex-end;
        background-color: #0d6efd;
        color: white;
        border-bottom-right-radius: 4px;
    }

    .hora-msg {
        display: block;
        font-size: 0.7rem;
        margin-top: 4px;
        opacity: 0.7;
        text-align: right;
    }

    .ticket-activo {
        background-color: #e7f1ff !important;
        border-left: 4px solid #0d6efd !important;
    }
</style>

<div class="container-fluid mt-3">
    <div class="row">
        <div class="col-md-4 border-end d-flex flex-column" style="height: 95vh;">

            <div class="p-3 bg-light border-bottom d-flex justify-content-between align-items-center">
                <h5 class="m-0">📥 Tickets</h5>
                <button class="btn btn-sm btn-outline-primary" onclick="sincronizarYRecargar()" title="Descargar mensajes de la cola">
                    <i class="fa fa-sync"></i> ↻ Actualizar
                </button>
            </div>

            <div id="listaTickets" class="list-group list-group-flush" style="overflow-y: auto;">
                <div class="text-center mt-5">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="small text-muted mt-2">Cargando tickets...</p>
                </div>
            </div>
        </div>

        <div class="col-md-8 d-flex flex-column" style="height: 95vh;">

            <div class="p-3 bg-primary text-white shadow-sm d-flex justify-content-between align-items-center">
                <div>
                    <h5 id="chatTitulo" class="m-0 fw-bold">Selecciona un ticket</h5>
                    <small id="chatSubtitulo" class="text-white-50">...</small>
                </div>
                <span class="badge bg-light text-primary" id="badgeId">#</span>
            </div>

            <div id="cajaMensajes" class="flex-grow-1 p-4" style="overflow-y: auto; display: flex; flex-direction: column; gap: 15px; background-color: #f8f9fa;">
                <div class="text-center text-muted mt-5">
                    <i class="fa fa-comments fa-3x mb-3"></i>
                    <p>Selecciona un usuario de la izquierda para ver la conversación.</p>
                </div>
            </div>

            <div class="p-3 border-top bg-light d-flex gap-2">
                <input type="hidden" id="ticketActualId" value="0">
                <input type="text" id="txtRespuesta" class="form-control" placeholder="Escriba un mensaje..." disabled autocomplete="off">
                <button class="btn btn-primary px-4" id="btnEnviar" onclick="enviarMensaje()" disabled>
                    Enviar ➤
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    // === CONFIGURACIÓN ===
    const API_URL = "https://localhost:7232/api/Soporte"; // Verifica tu puerto

    document.addEventListener("DOMContentLoaded", () => {
        // Carga inicial (solo lista, sin sincronizar cola aun)
        cargarTickets();
    });

    // === SINCRONIZACIÓN MANUAL ===
    async function sincronizarYRecargar() {
        const btn = document.querySelector(".btn-outline-primary");
        const icono = btn ? btn.querySelector("i") : null;

        // Efecto visual de carga
        if(btn) btn.disabled = true;
        if(icono) icono.classList.add("fa-spin");

        try {
            console.log("Iniciando sincronización manual...");

            // 1. Descargar cola MSMQ -> Base de Datos
            await fetch(`${API_URL}/sincronizar`);

            // 2. Refrescar la lista de tickets (izquierda)
            await cargarTickets();

            // 3. Si hay un chat abierto, refrescar sus mensajes también
            const idAbierto = document.getElementById("ticketActualId").value;
            if (idAbierto && idAbierto !== "0") {
                await actualizarMensajes(idAbierto);
            }

            console.log("Sincronización completada.");

        } catch (e) {
            console.error("Error al sincronizar:", e);
            alert("No se pudo conectar con el servidor.");
        } finally {
            if(btn) btn.disabled = false;
            if(icono) icono.classList.remove("fa-spin");
        }
    }

    // 1. CARGAR LISTA DE TICKETS
    async function cargarTickets() {
        const contenedor = document.getElementById("listaTickets");
        // Solo mostramos spinner si está vacío para no parpadear en recargas
        if(contenedor.innerHTML.trim() === "") {
             contenedor.innerHTML = `<div class="text-center mt-5"><div class="spinner-border text-primary"></div></div>`;
        }

        try {
            // Agregamos un timestamp para evitar caché del navegador en la lista
            const response = await fetch(`${API_URL}?t=${new Date().getTime()}`);
            if (!response.ok) throw new Error("Error API");

            let tickets = await response.json();

            if (!tickets || tickets.length === 0) {
                contenedor.innerHTML = "<p class='text-center text-muted mt-4'>No hay tickets.</p>";
                return;
            }

            const idSeleccionado = document.getElementById("ticketActualId").value;
            contenedor.innerHTML = "";

            tickets.sort((a, b) => (b.id || b.Id) - (a.id || a.Id));

            tickets.forEach(t => {
                const id = t.id || t.Id;
                const nombre = t.nombreCliente || t.NombreCliente || "Sin Nombre";
                const asunto = t.asunto || t.Asunto || "Consulta";
                const fechaRaw = t.fechaRegistro || t.FechaRegistro;

                const item = document.createElement("a");
                item.className = "list-group-item list-group-item-action py-3 border-bottom";
                if(id == idSeleccionado) item.classList.add("ticket-activo");

                item.style.cursor = "pointer";
                item.id = `ticket-${id}`;

                item.innerHTML = `
                    <div class="d-flex w-100 justify-content-between align-items-center mb-1">
                        <strong class="text-dark">${nombre}</strong>
                        <small class="text-muted" style="font-size:0.75rem">${new Date(fechaRaw).toLocaleDateString()}</small>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="text-secondary text-truncate small" style="max-width: 180px;">${asunto}</span>
                        <span class="badge bg-light text-dark border rounded-pill">#${id}</span>
                    </div>
                `;

                item.onclick = () => seleccionarTicket(id, nombre, asunto, item);
                contenedor.appendChild(item);
            });

        } catch (e) {
            contenedor.innerHTML = `<div class="alert alert-danger m-2">Error: ${e.message}</div>`;
        }
    }

    // 2. SELECCIONAR UN TICKET
    function seleccionarTicket(id, nombre, asunto, elementoHTML) {
        // Estilos visuales
        document.querySelectorAll('.list-group-item').forEach(el => el.classList.remove('ticket-activo'));
        elementoHTML.classList.add('ticket-activo');

        // Datos Cabecera
        document.getElementById("ticketActualId").value = id;
        document.getElementById("chatTitulo").innerText = nombre;
        document.getElementById("chatSubtitulo").innerText = asunto;
        document.getElementById("badgeId").innerText = "#" + id;

        document.getElementById("txtRespuesta").disabled = false;
        document.getElementById("btnEnviar").disabled = false;
        document.getElementById("txtRespuesta").focus();

        actualizarMensajes(id);
    }

    // 3. DIBUJAR MENSAJES
    async function actualizarMensajes(id) {
        try {
            const response = await fetch(`${API_URL}/${id}/mensajes?t=${new Date().getTime()}`);
            if(response.ok) {
                const mensajes = await response.json();
                const caja = document.getElementById("cajaMensajes");

                const usuarioHizoScrollArriba = caja.scrollTop + caja.clientHeight < caja.scrollHeight - 50;

                caja.innerHTML = "";

                if(mensajes.length === 0) {
                    caja.innerHTML = "<div class='text-center text-muted mt-5'>No hay mensajes aún.</div>";
                    return;
                }

                mensajes.forEach(m => {
                    const texto = m.contenido || m.Contenido || "";
                    let esAdmin = (m.esAdmin !== undefined) ? m.esAdmin : m.EsAdmin;
                    const fecha = m.fecha || m.Fecha;

                    const div = document.createElement("div");
                    div.className = `mensaje ${esAdmin ? 'msg-admin' : 'msg-cliente'}`;

                    div.innerHTML = `
                        ${texto}
                        <span class="hora-msg">
                            ${new Date(fecha).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                        </span>
                    `;
                    caja.appendChild(div);
                });

                if (!usuarioHizoScrollArriba) {
                    caja.scrollTop = caja.scrollHeight;
                }
            }
        } catch(e) { console.error("Error cargando mensajes", e); }
    }

    // 4. ENVIAR MENSAJE + AUTO SYNC
    async function enviarMensaje() {
        const hiddenId = document.getElementById("ticketActualId");
        const input = document.getElementById("txtRespuesta");

        if (!hiddenId || !input) return;

        const id = hiddenId.value;
        const texto = input.value;

        if(!texto.trim()) return;

        input.disabled = true;

        const datos = {
            TicketId: parseInt(id),
            Contenido: texto,
            EsAdmin: true
        };

        try {
            // A. Enviar el mensaje al servidor
            const response = await fetch(`${API_URL}/${id}/mensajes`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(datos)
            });

            if (response.ok) {
                input.value = "";

                // B. Sincronizar automáticamente tras enviar
                console.log("Mensaje enviado. Ejecutando sincronización completa...");
                await sincronizarYRecargar();

            } else {
                alert("Error al enviar el mensaje.");
            }
        } catch (error) {
            console.error("Error envío:", error);
            alert("Error de conexión");
        } finally {
            input.disabled = false;
            input.focus();
        }
    }
    // Enviar con Enter
    document.getElementById("txtRespuesta").addEventListener("keypress", function(e) {
        if (e.key === "Enter") enviarMensaje();
    });

</script>